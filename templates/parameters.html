<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/static/css/bulma.css" />
    <link rel="icon" type="image/png" href="/static/icon.png" sizes="400x400">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      window.onload = function() {
        console.log("loaded window")
        var buttons = document.getElementsByClassName("abort");
        for (var i = 0; i < buttons.length; i++) {
          buttons[i].addEventListener('click', function(){ 
            console.log("clicked!!!!")
            // alert(this.name);
            var job_name = this.name;
            job_name = job_name.substring(0,job_name.indexOf('?'));
            console.log(job_name);
            var modal = document.getElementById("myModal");
            var close = document.getElementById("close");
            var cancel = document.getElementById("cancel");
            var confirmDel = document.getElementById("confirm");
            var dmodal = document.getElementById("confirmDelete");
            var close2 = document.getElementById("close2");
            var cancel2 = document.getElementById("cancel2");
            var conDel = document.getElementById("confirmD");
            
            modal.style.display = "block";
            var job = document.getElementById("jobname");
            job.innerHTML = '"' + job_name + '"';
            job.name = job_name;
            
            close.onclick = function() {
              modal.style.display = "none";
            }
            cancel.onclick = function() {
              modal.style.display = "none";
            }
            confirmDel.onclick = function() {
              modal.style.display = "none";
              dmodal.style.display = "block";
              cancel2.href = "/abort/"+job.name;
              conDel.href = "/abort/delete/"+job.name;
              console.log(cancel2.href);
              console.log(conDel.href);
            }
            close2.onclick = function() {
              dmodal.style.display = "none";
            }
            cancel2.onclick = function() {
              dmodal.style.display = "none";
              // alert(this.name);
            }
          });
        }
      }
    </script>
    <title>Home</title>
</head>
<body>
    {% extends "page_template.html" %}
    {% block content %}
    <!-- Titles -->
    <div class="hero-body">
      {% with messages = get_flashed_messages() %}
				{% if messages %}
					{% for message in messages %}
					<div class="notification is-danger is-light" id="flash">
						<button class="delete" onclick="hide()"></button>
						{{ message }}
					</div>
					{% endfor %}
				{% endif %}
			{% endwith %}
      
      <div class="container is-widescreen">
        <div class="columns">
          <div class="column is-one-quarter">
            <table class="table is-hoverable is-bordered is-fullwidth">
              <thead>
                  <tr>
                      <th>Queued Jobs</td>
                  </tr>
              </thead>
              <tbody id="jobsQueue">
              </tbody>
          </table>
          </div>
          <div class="column">
              <!-- Start parameter input -->
              <center><h1 class="title is-4">Input your parameters here:</h1> <br></center>
              <form method=POST>
                <div class="field">
                  <div class="control">
                    <!-- Job name input -->
                    <b> * = required </b><br><br>
                    <label class="subtitle is-5" for="job_name">Job name: *</label><br>
                    <input class="input" id="job_name" name="job_name" type="text" placeholder="Job Name" value="{{ job_name }}" required>
                    {% if errors %}
                    {% if errors['job_name'] %}
                    <script>
                      document.getElementById("job_name").className = "input is-danger";
                    </script>
                    <p class="help is-danger"> {{ errors['job_name'] }} </p>
                    {% endif %}
                    {% endif %}
                  </div>
                </div>
                <br>
                <div class="field">
                  <div class="control">
                    <!-- pipeline select -->
                    <label class="subtitle is-5" for="pipeline"> Select a pipeline to run: *</label><br><br>
                        <input type="radio" id="nanopolish" name="pipeline" value="nanopolish">
                        <label for="nanopolish"> Nanopolish</label><br>
                        <input type="radio" id="medaka" name="pipeline" value="medaka">
                        <label for="medaka"> Medaka</label><br>
                        <input type="radio" id="both" name="pipeline" value="both">
                        <label for="both"> Both</label>
                    <script>
                      if ( {{ pipeline }}.value == "nanopolish") {
                        document.getElementById("nanopolish").checked = true;
                      } else if ( {{ pipeline }}.value == "medaka") {
                        document.getElementById("medaka").checked = true;
                      } else if ( {{ pipeline }}.value == "both") {
                        document.getElementById("both").checked = true;
                      } 
                    </script>
                    
                  </div>
                </div>

                <!-- select input folder -->

                <br>
                <label class="subtitle is-5">Select an input folder: *</label><br><br>
                  <input class="input" list="search" name="input_folder" id="input_folder" placeholder="Search for input folder" value="{{input_name}}" required>
                    <datalist id="search">
                      {% if folders %}                      
                        {% for folder in folders %}                          
                          <option value="{{ folder }}">{{ folder }}</option>
                        {% endfor %}
                      {% endif %}
                    </datalist>

                <br><br>
                <!-- select sample-csv -->
                <label class="subtitle is-5">Select a CSV file: </label><br>
                <small>(Only needed if there are multiple samples)</small><br>
                  <input class="input" list="csv_search" name="csv_file" id="csv_file" placeholder="Search for CSV file" value="{{csv_name}}">
                    <datalist id="csv_search">
                      {% if csvs %}                      
                        {% for csv in csvs %}                          
                          <option value="{{ csv }}">{{ csv }}</option>
                        {% endfor %}
                      {% endif %}
                    </datalist>

                <br><br>
                <!-- file path input -->
                <center><p class="subtitle is-5"><b>Input file paths</b> </p></center><br>
                <small>These must be absolute file paths, starting with either "/" or "C:\"</small><br><br>
                <!-- read file path - Medaka/ Nanopolish-->
                <label class="subtitle is-5" for="scheme_folder">Read file:</label><br>
                <small>(only input if you already have this file, otherwise artic gather/ demultiplex will generate it)</small><br>
                <input class="input" type="text" id="read_file" name="read_file" size="80" value="{{read_file}}"><br>
                {% if errors %}
                {% if errors['read_file'] %}
                <script>
                  document.getElementById("read_file").className = "input is-danger";
                </script>
                <p class="help is-danger"> {{ errors['read_file'] }} </p>
                {% endif %}
                {% endif %}
                <br>

                <!-- output folder file path - Medaka/ Nanopolish-->
                <label class="subtitle is-5" for="output_folder">Output folder: </label><br>
                <small>(if no output folder is provided, one will be created inside the input folder)</small><br>
                <input class="input" type="text" id="output_folder" name="output_folder" size="80" value="{{output_folder}}"><br>
                {% if errors %}
                {% if errors['override'] == True %}
                <script>
                  document.getElementById("output_folder").classList.add("is-danger");
                </script>
                {% endif %}
                {% endif %}
                <br>
                <!-- override output data?-->
                <input type="checkbox" id="override_data" name="override_data">
                <label for="override_data">Override existing data?</label><br><br>

                <center><h2 class="subtitle"><b>Primer Scheme</b></h2></center><br>
                <div class="field">
                  <div class="control">
                    <!-- primer type -->
                    <label class="subtitle is-5" for="primer_type"> Select a primer type: *</label><br>
                    <input type="radio" id="artic" name="primer_type" value="artic" onclick="setSchemes(this.id, {{schemes}})">
                    <label for="artic"> Artic</label><br>
                    <input type="radio" id="kirby" name="primer_type" value="kirby" onclick="setSchemes(this.id, {{schemes}})">
                    <label for="kirby"> Kirby</label><br>
                    Other <input type="text" id="other" name="primer_type" size="20"><br>
                  </div>

                  <script>
                      if ( {{ primer_type }}.id == "artic") {
                        document.getElementById("artic").checked = true;
                      } else if ( {{ primer_type }}.id == "kirby") {
                         document.getElementById("kirby").checked = true;
                      } else {
                        document.getElementById("other").value = {{ primer_type }};
                      }
                    </script>
                </div>

                <!-- primer scheme directory -->
                <label class="subtitle is-5" for="primer_scheme">Scheme folder: *</label><br>
                <input class="input" type="text" id="primer_scheme_dir" name="primer_scheme_dir" size="60" value="{{primer_scheme_dir}}" required><br>
                {% if errors %}
                {% if errors['primer_scheme_dir'] %}
                <script>
                  document.getElementById("primer_scheme_dir").className = "input is-danger";
                </script>
                <p class="help is-danger"> {{ errors['primer_scheme_dir'] }} </p>
                {% endif %}
                {% endif %}
                <br>

                <!-- primer scheme name -->
                <label class="subtitle is-5" for="primer_scheme">Primer Name: *</label><br>
                <small> e.g. nCoV-2019/V1 </small><br>
                <input class="input" type="text" id="primer_scheme" name="primer_scheme" size="30" value="{{primer_scheme}}" required><br><br>


                <div class="field">
                  <div class="control">
                    <!-- barcode type -->
                    <br>
                    <label class="subtitle is-5" for="barcode_type"> Select a barcode type: *</label><br><br>
                    <input type="radio" id="native" name="barcode_type" value="native" onclick="setParams()">
                    <label for="native"> Native</label><br>
                    <input type="radio" id="rapid" name="barcode_type" value="rapid" onclick="setParams()">
                    <label for="rapid"> Rapid</label><br>
                  </div>
                 
                </div>
                 <script>
                    if ( {{ barcode_type }}.id == "native") {
                      document.getElementById("native").checked = true;
                    } else if ( {{ barcode_type }}.id == "rapid") {
                       document.getElementById("rapid").checked = true;
                    } 
                  </script>
                <br>

                <div class="field">
                  <div class="control">
                    <!-- Parameter selection -->
                    <!--when medaka is selected then the current parameters appear-->
                    <!-- threads - Medaka/ Nanopolish-->
                    <center><h1 class="subtitle"><b>Select parameters</b></h1></center><br>
                    <h1 class="subtitle is-5">Gather command: *</h1>
                   
                    <label for="min_length">Minimum Length: *</label>
                    <input class="input" type="number" id="min_length" name="min_length" value="{{ min_length }}" required><br>
                    <br><label for="max_length">Maximum Length: *</label>
                    <input class="input" type="number" id="max_length" name="max_length" value="{{ max_length }}" required><br>
                    {% if errors %}
                    {% if errors['invalid_length'] %}
                      <script>
                        document.getElementById("min_length").className = "input is-danger";
                        document.getElementById("max_length").className = "input is-danger";
                      </script>
                      <p class="help is-danger"> {{ errors['invalid_length'] }} </p>
                    {% endif %}
                    {% endif %}
                    <br>
                    <h1 class="subtitle is-5">Other parameters: *</h1>
                    <label for="num_threads">Thread usage: *</label>
                    <input class="input" type="number" id="num_threads" name="num_threads" value="4" required><br>
                    <!-- normalise - Medaka/ Nanopolish-->
                    <br>
                    <label for="normalise">Normalise: *</label>
                    <input class="input" type="number" id="normalise" name="normalise" value="200" required><br>
                    <!--<br>
                    <div id="nanoParams" style="display:none">
                      <h1 class="title is-6">Nanopolish parameters:</h1>
                      <br>
                    </div>
                    <div id="medakaParams" style="display:none">
                      <h1 class="title is-6">Medaka parameters:</h1>
                    </div> -->
                  </div>
                </div>

                <div class="field">
                  <div class="control">
                    <!-- single or multiple samples -->
                    <br>
                    <h1 class="subtitle">This input contains: *</h1>
                    <input type="radio" id="single" name="num_samples" value="single" required>
                    <label for="single">A single sample</label><br>
                    <input type="radio" id="multiple" name="num_samples" value="multiple">
                    <label for="multiple">Multiple samples</label><br>
                  </div>
                </div>
                
                <script>
                    if ( {{ num_samples }}.id == "single") {
                      document.getElementById("single").checked = true;
                    } else if ( {{ num_samples }}.id == "multiple") {
                       document.getElementById("multiple").checked = true;
                    } 
                  </script>

                <br>
                <div class="field">
                    <div class="control">
                        {% if errors %}
                        {% if errors['full_queue'] %}
                        <p class="has-text-danger"> {{ errors['full_queue'] }} </p>
                        {% endif %}
                        {% endif %}
                        <br>
                        <input class="button" id="submit_job" name="submit_job" type="submit" value="Submit Job(s)"><br>
                    </div>
                </div>
                <br>
              </form>
            </div>
          </div>
        </div>
        <!-- modal -->
      <div class="modal" id="myModal">
        <div class="modal-background"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Abort Job</p>
            <button id="close" class="delete" aria-label="close"></button>
          </header>
          <section class="modal-card-body">
          Are you sure you want to ABORT <p id="jobname" style="display:inline"></p>?
          </section>
          <footer class="modal-card-foot">
            <button id="confirm" class="button is-success">Yes</button>
            <button id="cancel" class="button">Cancel</button>
          </footer>
        </div>
      </div>

      <div class="modal" id="confirmDelete">
        <div class="modal-background"></div>
        <div class="modal-card">
          <header class="modal-card-head">
            <p class="modal-card-title">Abort Job</p>
            <button id="close2" class="delete" aria-label="close"></button>
          </header>
          <section class="modal-card-body">
          Do you want to delete the files created from the run?
          </section>
          <footer class="modal-card-foot">
            <a id="confirmD" class="button is-success">Yes</a>
            <a id="cancel2" class="button is-danger">No</a>
          </footer>
        </div>
      </div>
      <!-- // -->
      </div>

      <script>
        //primers
        var artic = document.getElementById("artic");
        var kirby = document.getElementById("kirby");
        //barcodes
        var native = document.getElementById("native");
        var rapid = document.getElementById("rapid");

        function setSchemes(id, schemesJson) {
          var primer_scheme_dir = document.getElementById("primer_scheme_dir");
          var primer_scheme= document.getElementById("primer_scheme");
          if (id == 'artic') {
            primer_scheme_dir.value = schemesJson['artic_scheme'];
            primer_scheme.value = schemesJson['artic_scheme_name'];
          } else if (id == 'kirby') {
            primer_scheme_dir.value = schemesJson['kirby_scheme'];
            primer_scheme.value = schemesJson['kirby_scheme_name'];
          }
          setParams()
        }
        
        //max/min length
        function setParams() {
          var max_length = document.getElementById("max_length");
          var min_length = document.getElementById("min_length");
          if(artic.checked && native.checked) {
            max_length.value = '500';
            min_length.value = '300';
          } else if (kirby.checked && native.checked) {
            max_length.value = '2700';
            min_length.value = '2300';
          } else if (kirby.checked && rapid.checked) {
            max_length.value = '2700';
            min_length.value = '300';
          } else {
            max_length.value = '';
            min_length.value = '';
          }
        }
        function hide() {
          var message = document.getElementById("flash");
          message.style.display = "none";
        }

        // Displaying the Queue
        const jobsQueue = document.getElementById("jobsQueue");

         var jobsJson = JSON.parse({{ queue|tojson|safe }});
         console.log("Jobs Queue: ", jobsJson);

         if (jobsJson != null) {
             var jobs = jobsJson.jobs;
             jobs.forEach(job => {
                 for (var key of Object.keys(job)) {
                     const curJobRow = document.createElement("tr");
                     const curJob = document.createElement("td");
                     const linkNode = document.createElement("a");
                     const textNode = document.createTextNode(key);
                     linkNode.href = job[key];

                     const btn = document.createElement("a");
                     btn.innerHTML = "Abort";
                     btn.classList.add("button");
                     btn.classList.add("is-danger");
                     btn.classList.add("is-light");
                     btn.style = "float:right";
                     btn.classList.add("abort")
                     btn.name = job[key].replace("/progress/", "")

                     linkNode.appendChild(textNode);
                     curJob.appendChild(linkNode);
                     curJob.appendChild(btn);
                     curJobRow.appendChild(curJob);
                     jobsQueue.appendChild(curJobRow);
                 };
             });
         } else {
             const curJobRow = document.createElement("tr");
             const curJob = document.createElement("td");
             const textNode = document.createTextNode("You currently have no queued jobs.");
             curJob.classList.add("has-text-grey-light");
             curJob.classList.add("is-italic");

             curJob.appendChild(textNode);
             curJobRow.appendChild(curJob);
             jobsQueue.appendChild(curJobRow);
         };
        </script>

    {% endblock %}
</body>
</html>
