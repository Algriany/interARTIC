<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <style>
		
	</style>
	<meta charset="utf-8">
    <title>Progress</title>
	<link rel="stylesheet" href="/static/css/bulma.min.css"/>
	<link rel="stylesheet" href="/static/css/confirm_modal.css"/>	
	<link rel="stylesheet" href="/static/css/page_template.css"/>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	
  </head>
  <body>
    {% extends "page_template.html" %}
    {% block content %}
    <div class="hero-body">
		<div class="container is-fluid">

			<center>
				<h1 class="title is-4">Progress for {{ job_name }}</h1>
				<h2 class="title is-5">Job {{ num_in_queue }} of {{ queue_length }} in queue</h2>
			<br>
			<label for="file">Pipeline progress:</label><br>
			<button class="button is-danger is-light" id="abortBtn" onclick="showConfirmModal()">Abort Job</button><br><br>
				<h1 id='status'> <h1><br>

				<div id="progress-bar">

			</div>

				</div>
			<br><br>
			</center>

			<!--<div id="dialog-confirm" style="background:#ffffff;border:1px solid">
				{% if error %}
					<p>
					ERROR OCCURRED
					</p>
				{% endif %}
			</div>

			<!--<h1 class="title is-6">Commands being run: <h1>
    		<code>print cmds here</code>
			<br>-->
		

			<!-- <p>
    			{{ min_cmd }} <br>
    		</p> -->
			

			<center>
				<h1 class="title is-5">Output from the ARTIC Pipeline:</h1>
			</center>
				<div id="outputLog">
					<br>
					<pre style="white-space: pre-wrap; word-wrap: break-word;"><code>{{ outputLog|safe }}
					</code></pre><br><br>
				</div>
			
			<br><br>
			<center>
			<button id="direct_to_output" class="float-left submit-button">Go to output</button>
			</center>
			<script type="text/javascript">
				document.getElementById("direct_to_output").onclick = function () {
					location.href = "/output/{{ job_name }}";
				};
			</script>

		</div>
	</div>

	<div id="confirmModal" class="modal">
		<!-- Modal content -->
		<div class="modal-content">
			<h1>Abort Job</h1>
			<p>You are about to abort a job which is currently running. This action is irreversible.
				Continue?</p>
			<button id="cancelAbortBtn" onclick="cancel()">No</button>
			<button id="confirmAbortBtn" onclick="confirm()">Yes</button>
		</div>

	</div>

	<script src="//cdnjs.cloudflare.com/ajax/libs/nanobar/0.2.1/nanobar.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script>
		var abortBtn = document.getElementById("abortBtn");
		var confirmModal = document.getElementById("confirmModal");
		var cancelAbort = document.getElementById("cancelAbortBtn");
		var confirmAbort = document.getElementById("confirmAbortBtn");


		function showConfirmModal() {
			confirmModal.style.display = "block";
		}
		function cancel() {
  			confirmModal.style.display = "none";
		}
		function confirm() {
  			
		}


		const status_div = document.getElementById('status');
		//const para = document.createElement("p");
		//para.innerHTML = JSON.stringify(stat);
		//status.appendChild(para);

        // create a progress bar
        var nanobar = new Nanobar({
            bg: '#44f',
            target: document.getElementById('progress-bar')
		});
		//nanobar.go(0);
		//update_progress('{{ url }}', nanobar, status_div );

		//var bar = document.getElementById('progress-bar');
		//bar.appendChild(nanobar)


		console.log("{{ job_name }}")
		$.ajax({
			type: 'POST',
			url: '/task/{{ job_name }}',
			success: function(data, status, request) {
				status_url = request.getResponseHeader('Location');
				update_progress(status_url, nanobar, status_div );
			},
			error: function() {
				alert('Unexpected error');
			}
		});





		function update_progress(status_url, nanobar, status_div) {
        // send GET request to status URL
			$.getJSON(status_url, function(data) {
				// update UI
				percent = parseInt(data['current'] * 100 / data['total']);
				nanobar.go(percent);
				$(status_div.childNodes[1]).text(percent + '%');
				$(status_div.childNodes[2]).text(data['status']);
				if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
					if ('result' in data) {
						// show result
						$(status_div.childNodes[3]).text('Result: ' + data['result']);
					}
					else {
						// something unexpected happened
						$(status_div.childNodes[3]).text('Result: ' + data['state']);
					}
				}
				else {
					// rerun in 2 seconds
					setTimeout(function() {
						update_progress(status_url, nanobar, status_div);
					}, 2000);
				}
			});
    	}


	</script>

	<script>
		$(document).ready(function() {
			setInterval(function() {
				$( "#outputLog" ).load(window.location.href + " #outputLog" );
				//ÃŸ$( "#dialog-confirm" ).load(window.location.href + " #dialog-confirm" );
			}, 900); 
		});
	</script>
	

	<!--<script> 
		$( function() {
			$( "#dialog-confirm" ).dialog({
				autoOpen: false,
				resizable: false,
				height: 200,
				width: 200,
				modal: true,
				buttons: {
					"Restart": function() {
						$( this ).dialog( "close" );
					},
					Cancel: function() {
						$( this ).dialog( "close" );
					}
				},
				dialogClass: 'no-close success-dialog'
			});
		} );
		$(document).ready(function() {
			setInterval( function() {
				var errors = ["{{ error|safe }}"];
				console.log(errors[0]);
				if (errors[0] != null) {
					$( "#dialog-confirm" ).dialog( "open" );
				} 
			}, 1000);
		});
	</script> -->
    {% endblock %}
  </body>
</html>
